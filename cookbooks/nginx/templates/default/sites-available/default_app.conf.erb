server {
  listen         80;
  server_name    <% @domain_names.each do | domain_name | %><%= domain_name %> <% end %>;
  root           <%= @app_root_dir %>;
  include        /etc/nginx/fastcgi_params;
  fastcgi_index  index.php;
  index          index.php;
  
  port_in_redirect        off;
  client_max_body_size    100M;
  
  # serve static files directly
  location  ~* ^.+.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt)$ {
    access_log     off;
    expires        24h; #max
    root           <%= @app_root_dir %>;
  }
  # serve favicon.ico
  location = /favicon.ico {
    alias          <%= @app_root_dir %>/favicon.ico;
    access_log     off;
    log_not_found  off;
  }

  access_log <%= access_log_file_path %>;
  error_log  <%= error_log_file_path %>; notice;

  location / {
    index             index.php index.html;
    fastcgi_index     index.php;
    try_files         $uri $uri/ /index.php$is_args$args;
  }
  
  # Serve php files
  location ~ [^/]\.php(/|$) {
    root                           <%= @app_root_dir %>;
    include                        fastcgi_params;
    try_files                      $uri $uri =404;
    #fastcgi_split_path_info        ^(.+\.php)(/.+)$;
    fastcgi_pass                   unix:/var/run/php5-fpm.sock;
    #fastcgi_pass                  127.0.0.1:9000;
    fastcgi_index                  index.php;
    index                          index.php;

    proxy_set_header               X-Real-IP                      $remote_addr;
    proxy_set_header               X-Forwarded-For                $proxy_add_x_forwarded_for;
    proxy_set_header               Host                           $http_host;
    proxy_set_header               X-Queue-Start                  't=${msec}000';

    fastcgi_param                  SCRIPT_FILENAME                $document_root$fastcgi_script_name;
    fastcgi_param                  REQUEST_METHOD                 $request_method;
    fastcgi_param                  SERVER_NAME                    $hostname;
    
    #fastcgi_connect_timeout        60;
    #fastcgi_send_timeout           180;
    #fastcgi_read_timeout           180;
    #fastcgi_buffer_size            128k;
    #fastcgi_buffers                4                              256k;
    #fastcgi_busy_buffers_size      256k;
    #fastcgi_temp_file_write_size   256k;
    #fastcgi_intercept_errors       on;
  
  }
}

